```{r}
library("lubridate")
library("magrittr")
library("tidyverse")
library("cowplot")
library("glue")

theme_set(theme_cowplot())
```

# load data
```{r}

data <- read_csv("https://covid.ourworldindata.org/data/owid-covid-data.csv") %>% 
  select(
    country=location, date, 
    CPM=total_cases_per_million, CPM_per_day=new_cases_per_million, 
    DPM=total_deaths_per_million, DPM_per_day=new_deaths_per_million
  )
```

# preparations
```{r, fig.width=6}

countries <- c("France","Germany","Italy","Netherlands","Switzerland","Sweden","United States", "United Kingdom", "Brazil")

df <- data %>% 
  filter(country %in% countries)
  

df_cases <- df %>% 
  group_by(country) %>% 
  filter(CPM>.1) %>% 
  mutate(days_since_CPM_greater_0.1=date-min(date)) %>% 
  ungroup()

df_deaths <- df %>% 
  group_by(country) %>% 
  filter(DPM>100) %>% 
  mutate(days_since_DPM_greater=date-min(date)) %>% 
  ungroup()


df_dpm <- df %>% 
  group_by(country) %>% 
  filter(DPM>100) %>% 
  mutate(days_since_DPM_greater=date-min(date)) %>% 
  mutate(
    CFR=DPM/CPM,
    CFR_per_day=DPM_per_day/CPM_per_day
  ) %>% 
  ungroup()
```

# cases per million
```{r, fig.width=10}

p1 <- df_cases %>%   
  filter(CPM_per_day>=0) %>% 
  ggplot(aes(days_since_CPM_greater_0.1, CPM_per_day, color=country)) +
    geom_point(alpha=.7) +
    stat_smooth(method = "loess", span=.5, size=.6, color="black") +
    scale_color_manual(values=c(
                         RColorBrewer::brewer.pal(9,"Set1")[1:5],
                         ggsci::pal_jco()(2)[2],
                         RColorBrewer::brewer.pal(9,"Set1")[7:9]
                        )) +
    scale_y_continuous(trans="pseudo_log", breaks=c(0,2,10,50,300)) +
    facet_wrap(~country) +
    labs(x="days since >0.1 cases per million (CPM)", y="CPM per day") +
    labs(title="Daily cases") +
    theme(legend.position = "none")

p2 <- df_cases %>%   
  ggplot(aes(days_since_CPM_greater_0.1, CPM, color=country)) +
    geom_point(alpha=.7) +
    geom_path() +
    scale_color_manual(values=c(
                         RColorBrewer::brewer.pal(9,"Set1")[1:5],
                         ggsci::pal_jco()(2)[2],
                         RColorBrewer::brewer.pal(9,"Set1")[7:9]
                        )) +
    labs(x="days since >0.1 cases per million (CPM)", y="CPM") +
    labs(title="Total cases") +
    theme(legend.position = "none")

p3 <- df_deaths %>%   
  filter(DPM_per_day>=0) %>% 
  ggplot(aes(days_since_DPM_greater_0.05, DPM_per_day, color=country)) +
    geom_point(alpha=.7) +
    stat_smooth(method = "loess", span=.5, size=.6, color="black") +
    scale_y_continuous(trans="pseudo_log", breaks=c(0,2,10,30)) +
    scale_color_manual(values=c(
                         RColorBrewer::brewer.pal(9,"Set1")[1:5],
                         ggsci::pal_jco()(2)[2],
                         RColorBrewer::brewer.pal(9,"Set1")[7:9]
                        )) +
    facet_wrap(~country) +
    labs(x="days since >0.05 deaths per million (DPM)", y="DPM per day") +
    labs(title="Daily deaths") +
    theme(legend.position = "none")

p4 <-  df_deaths %>%   
  ggplot(aes(days_since_DPM_greater_0.05, DPM, color=country)) +
    geom_point(alpha=.7) +
    geom_path() +
    scale_color_manual(values=c(
                         RColorBrewer::brewer.pal(9,"Set1")[1:5],
                         ggsci::pal_jco()(2)[2],
                         RColorBrewer::brewer.pal(9,"Set1")[7:9]
                        )) +
    labs(x="days since >0.05 deaths per million (DPM)", y="DPM") +
    ggtitle("Total deaths") +
    theme(legend.position = "none")

p5 <- df_dpm %>%   
  filter(is.finite(1/CFR_per_day)) %>% 
  ggplot(aes(days_since_DPM_greater, 1/CFR_per_day, color=country)) +
    geom_point(alpha=.7) +
    stat_smooth(method = "loess", span=.5, size=.6, color="black") +
    scale_y_log10() +
    scale_color_manual(values=c(
                         RColorBrewer::brewer.pal(9,"Set1")[1:5],
                         ggsci::pal_jco()(2)[2],
                         RColorBrewer::brewer.pal(9,"Set1")[7:9]
                        )) +
    facet_wrap(~country) +
    labs(x="days since >100 deaths per million (DPM)", y="Cases per fatality (1/CFR)") +
    labs(title="Daily case fatality ratio") +
    theme(legend.position = "none")

p6 <-  df_dpm %>%   
  ggplot(aes(days_since_DPM_greater, 1/CFR, color=country)) +
    geom_point(alpha=.7) +
    geom_path() +
    scale_color_manual(values=c(
                         RColorBrewer::brewer.pal(9,"Set1")[1:5],
                         ggsci::pal_jco()(2)[2],
                         RColorBrewer::brewer.pal(9,"Set1")[7:9]
                        )) +
    labs(x="days since >100 deaths per million (DPM)", y="Cases per fatality (1/CFR)") +
    ggtitle("Accumulated case fatality ratio") +
    theme(legend.position = "none")

plot_grid(
  ggdraw()+draw_label("COVID-19 Dynamics", fontface="bold", size=24),
  ggdraw()+draw_label(glue("last update: {format(max(df$date),format='%d.%m.%Y')}")),
  NULL,
  plot_grid(p1,p3,p5,p2,p4,p6, ncol=3), ncol=1, rel_heights = c(.1,.02,.1,2)
)

ggsave("covid_19_dynamics.pdf", width=25, height=14)
```